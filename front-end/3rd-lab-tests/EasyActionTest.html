<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="EasyActionTestStyle.css">
  <title>Easy Action Test</title>
</head>

<body>
<progress id="progress" value="0" max="100"></progress>
<div id="start-button-enclosing">
  <button id="start-button" onclick="hideButton()">Начать тест</button>
</div>
<div id="submit-button-enclosing"></div>
<div id="restart-button-enclosing"></div>
<div id="result-enclosing"></div>

<canvas id="canvas" width="550" height="400"></canvas>
</body>

<script>
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const circleRadius = 30;
  const fixedCircleX = canvas.width / 2;
  const fixedCircleY = canvas.height / 2;
  let directionX = Math.floor(Math.random() * 350) + 25;
  let directionY = Math.floor(Math.random() * 250) + 25;
  let speedX = Math.floor(Math.random() * 10) + 3;
  let speedY = Math.floor(Math.random() * 10) + 3;
  let testCounter = 0;
  let totalDistance = 0;
  let result = 0;
  let hitAccuracy = 0;
  let reactionTime = 0;

  function changeBackgroundColor() {
    canvas.style.backgroundColor = "#fff";
  }

  function hideButton() {
    //const newColor = prompt("Введите новый цвет фона:");
    document.getElementById("start-button").style.display = "none";
    //canvas.style.backgroundColor = newColor;
    changeBackgroundColor();
    drawFrame();
    drawCircles();
    moveCircle();
  }
  function drawFrame() {
    const frameX = canvas.width;
    const frameY = canvas.height;
    context.fillStyle = canvas.style.backgroundColor;
    context.fillRect(frameX, frameY, canvas.width, canvas.height); // draw frame
  }

  function drawCircles() {
    context.beginPath();
    context.arc(fixedCircleX, fixedCircleY, circleRadius, 0, 2 * Math.PI); // draw fixed circle
    context.fillStyle = "rgba(12, 28, 67)";
    context.fill();

    context.beginPath();
    context.arc(directionX, directionY, circleRadius, 0, 2 * Math.PI); // draw moving circle
    context.fillStyle = "rgba(0, 103, 187)";
    context.fill();
  }

  function moveCircle() {
    directionX += speedX;
    directionY += speedY;

    if (directionX < 20 || directionX > canvas.width) {
      speedX = -speedX;
    }
    if (directionY < 20 || directionY > canvas.height) {
      speedY = -speedY;
    }

    context.clearRect(0, 0, canvas.width, canvas.height); // clear screen
    drawFrame();
    drawCircles();
    requestAnimationFrame(moveCircle);
  }
  window.addEventListener("keydown", function (event) {
    if (event.code === "Space") {
      testCounter++;
      document.getElementById("progress").value = testCounter * 10;
      checkHit();
      if (testCounter === 15) {
        showResult();
        canvas.style.display = "none";
        const submitButtonEnclosing = document.getElementById("submit-button-enclosing");
        const submitButton = document.createElement("button");
        submitButton.textContent = "Отправить результат"
        submitButtonEnclosing.appendChild(submitButton);

        const restartButtonEnclosing = document.getElementById("restart-button-enclosing");
        const restartButton = document.createElement("button");
        restartButton.textContent = "Пройти заново"
        //restartButton.onclick = runTest
        restartButtonEnclosing.appendChild(restartButton);

        document.getElementById("progress").value = 0
        const resultEnclosing = document.getElementById("result-enclosing");
        const averageResult = result / testCounter;
        resultEnclosing.innerText = `Средняя точность попадания: ${averageResult.toFixed(2)}%`;
      }
    }
  });

  function checkHit() {
    const distance = Math.sqrt((directionX - fixedCircleX) ** 2 + (directionY - fixedCircleY) ** 2);
    if (distance <= circleRadius * 2) {
      testCounter++;
      hitAccuracy++;
      totalDistance += distance;
      reactionTime = new Date().getTime();
      showReactionAndAccuracy();
    } else {
      hitAccuracy = 0;
      showReactionAndAccuracy();
    }
  }
  function showReactionAndAccuracy() {
    const resultEnclosing = document.getElementById("result-enclosing");
    let message;
    if (hitAccuracy > 0) {
      let averageReactionTime;
      averageReactionTime = reactionTime / hitAccuracy;
      const accuracy = hitAccuracy / testCounter * 100;
      message = `Среднее время реакции: ${averageReactionTime.toFixed(2)} мс`;
      message += `Точность попадания: ${accuracy.toFixed(2)}%`;
    } else {
      message = 'Промах';
    }
    resultEnclosing.innerText = message;
  }

  function showResult() {
    /*    const resultEnclosing = document.getElementById("result-enclosing");
        let matchPercent;
        if (testCounter > 0) {
          const average = totalDistance / testCounter;
          matchPercent = 100 - (average / circleRadius * 100);
        } else {
          matchPercent = 0;
        }
        resultEnclosing.innerText = `Процент попадания: ${matchPercent.toFixed(2)}%`;
        result += matchPercent;*/
    const resultEnclosing = document.getElementById("result-enclosing");
    const average = totalDistance;
    totalDistance = 0;
    let matchPercent;
    if (hitAccuracy > 0) {
      matchPercent = 100 - (average / circleRadius * 100);
      if (matchPercent < 0) {
        matchPercent = 0;
      }
    } else {
      matchPercent = 0;
    }
    result += matchPercent;
    resultEnclosing.innerText = `Процент попадания: ${matchPercent.toFixed(2)}%`;
    /*    matchPercent = 100 - (average / circleRadius * 100);
        if (matchPercent < 0) {
          matchPercent = 0;
          resultEnclosing.innerText = `Процент попадания: ${matchPercent.toFixed(2)}%`;
          result += matchPercent;
        } else{
          resultEnclosing.innerText = `Процент попадания: ${matchPercent.toFixed(2)}%`;
          result += matchPercent;
        }*/
  }

</script>
</html>