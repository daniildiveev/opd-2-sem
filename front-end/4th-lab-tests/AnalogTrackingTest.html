<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="AnalogTrackingTestStyle.css">
  <title>Analog Tracking Test</title>
</head>
<body>
<progress id="progress" value="0" max="100"></progress>
<div id="start-button-enclosing">
  <button id="start-button" onclick="hideButton()">Начать тест</button>
</div>
<div id="submit-button-enclosing"></div>
<div id="restart-button-enclosing"></div>
<div id="result-enclosing"></div>

<canvas id="canvas" width="550" height="400"></canvas>
</body>
<script>
  // Определяем переменные
  let canvas = document.getElementById("canvas");
  let context = canvas.getContext("2d");
  let ballX = canvas.width / 2;
  let ballY = canvas.height / 2;
  let ballRadius = 10;
  let ballSpeed = 5;
  let dx = ballSpeed;
  let dy = -ballSpeed;
  let targetX = Math.floor(Math.random() * (canvas.width - 2 * ballRadius) + ballRadius);
  let targetY = Math.floor(Math.random() * (canvas.height - 2 * ballRadius) + ballRadius);
  let targetRadius = 20;
  let userX = canvas.width / 2;
  let userY = canvas.height - 50;
  let userRadius = 15;
  let userColor = "#0000FF";
  let leftPressed = false;
  let rightPressed = false;
  let accuracy = 0;
  let countDownDate, timerInterval;

  // Функция для отрисовки кадра
  function drawFrame() {
    // Очищаем холст
    context.clearRect(0, 0, canvas.width, canvas.height);

    // Рисуем управляемый шарик пользователя
    context.beginPath();
    context.arc(userX, userY, userRadius, 0, Math.PI*2);
    context.fillStyle = userColor;
    context.fill();
    context.closePath();

    // Рисуем шарик, двигающийся по экрану
    context.beginPath();
    context.arc(ballX, ballY, ballRadius, 0, Math.PI*2);
    context.fillStyle = "#0095DD";
    context.fill();
    context.closePath();

    // calculate accuracy
    const distance = Math.sqrt((userX - targetX) ** 2 + (userY - targetY) ** 2);
    accuracy = (1 - distance / (canvas.width + canvas.height - 4 * ballRadius)) * 100;

    // output accuracy
    context.font = "20px Arial";
    context.fillStyle = "#000000";
    context.fillText("Accuracy: " + accuracy.toFixed(2) + "%", 10, 30);

    // update coordinates
    ballX += dx;
    ballY += dy;

    // Если шарик вышел за границы холста, меняем направление движения
    if (ballX < ballRadius || ballX > canvas.width - ballRadius) {
      dx = -dx;
    }
    if (ballY < ballRadius || ballY > canvas.height - ballRadius) {
      dy = -dy;
    }

    // Проверяем, не столкнулся ли управляемый шарик с мишенью
    if (distance <= userRadius + targetRadius) {
      targetX = Math.floor(Math.random() * (canvas.width - 2 * ballRadius) + ballRadius);
      targetY = Math.floor(Math.random() * (canvas.height - 2 * ballRadius) + ballRadius);
    }
  }

  // Функция для обработки нажатия клавиш
  function keyDownHandler(event) {
    if (event.keyCode === 37) {
      leftPressed = true;
    }
    else if (event.keyCode === 39) {
      rightPressed = true;
    }
  }

  // Функция для обработки отпускания клавиш
  function keyUpHandler(event) {
    if (event.keyCode === 37) {
      leftPressed = false;
    }
    else if (event.keyCode === 39) {
      rightPressed = false;
    }
  }

  // Функция для перемещения управляемого шарика
  function moveUserBall() {
    if (leftPressed && userX > userRadius) {
      userX -= ballSpeed;
    }
    else if (rightPressed && userX < canvas.width - userRadius) {
      userX += ballSpeed;
    }
  }

  // Функция для скрытия кнопки "Начать тест" и запуска таймера
  function hideButton() {
    document.getElementById("start-button-enclosing").style.display = "none";

// Начинаем отсчет времени
    countDownDate = new Date().getTime() + 120000;
    timerInterval = setInterval(updateTimer, 1000);

// Запускаем анимацию шариков
    setInterval(function() {
      drawFrame();
      moveUserBall();
    }, 10);
  }

  // Функция для обновления таймера
  function updateTimer() {
    let now = new Date().getTime();
    let distance = countDownDate - now;
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    let timerText = "Time Left: " + minutes + "m " + seconds + "s ";
    context.font = "20px Arial";
    context.fillStyle = "#000000";
    context.fillText(timerText, canvas.width - 150, 30);

    if (distance < 0) {
      clearInterval(timerInterval);
      showResult();
    }
  }

  // Функция для показа итогового результата
  function showResult() {
    clearInterval(timerInterval);
    let resultText = "Your accuracy is " + accuracy.toFixed(2) + "%. Submit your result?";
    document.getElementById("result-enclosing").innerHTML = '<p>' + resultText + '</p><button id="result-submit" onclick="submitResult()">Yes</button><button id="result-cancel" onclick="hideResult()">Cancel</button>';
  }

  // Функция для скрытия итогового результата
  function hideResult() {
    document.getElementById("result-enclosing").innerHTML = '';
  }

  // Функция для перезапуска теста
  function restartTest() {
    clearInterval(timerInterval);
    ballX = canvas.width / 2;
    ballY = canvas.height / 2;
    dx = ballSpeed;
    dy = -ballSpeed;
    targetX = Math.floor(Math.random() * (canvas.width - 2 * ballRadius) + ballRadius);
    targetY = Math.floor(Math.random() * (canvas.height - 2 * ballRadius) + ballRadius);
    userX = canvas.width / 2;
    accuracy = 0;
    document.getElementById("start-button-enclosing").style.display = "block";
    document.getElementById("submit-button-enclosing").innerHTML = '';
    document.getElementById("restart-button-enclosing").innerHTML = '';
    document.getElementById("result-enclosing").innerHTML = '';
  }

  // Функция для отправки результата на сервер
  function submitResult() {
// Отправляем результат на сервер
    alert("Result submitted!");

// Перезапускаем тест
    restartTest();
  }

  // Добавляем обработчики событий для клавиатуры
  document.addEventListener("keydown", keyDownHandler, false);
  document.addEventListener("keyup", keyUpHandler, false);

</script>
</html>
